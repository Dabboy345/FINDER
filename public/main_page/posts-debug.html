<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Posts Debug Tool</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .post { border: 1px solid #ccc; margin: 10px 0; padding: 15px; border-radius: 5px; }
        .post-header { font-weight: bold; margin-bottom: 10px; }
        .post-type { color: white; padding: 3px 8px; border-radius: 3px; font-size: 12px; }
        .lost { background-color: #dc3545; }
        .found { background-color: #28a745; }
        button { padding: 10px 20px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>Posts Debug Tool</h1>
    
    <div>
        <button onclick="loadPosts()">Load All Posts</button>
        <button onclick="createTestPosts()">Create Test Posts</button>
        <button onclick="testRecommendations()">Test Recommendations</button>
    </div>
    
    <div id="output"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
        import { getDatabase, ref, get, push } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBmS-i8N6sFOB4khvIpX-_fFN3ITebSS0g",
            authDomain: "finder-ff519.firebaseapp.com",
            databaseURL: "https://finder-ff519-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "finder-ff519",
            storageBucket: "finder-ff519.appspot.com",
            messagingSenderId: "989218762868",
            appId: "1:989218762868:web:7f5160caf34ddccd92e121"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            console.log('Current user:', user?.uid || 'Not logged in');
        });

        window.loadPosts = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Loading posts...</p>';
            
            try {
                const snapshot = await get(ref(db, 'posts'));
                const posts = snapshot.val();
                
                if (!posts) {
                    output.innerHTML = '<p>No posts found in database.</p>';
                    return;
                }
                
                const postEntries = Object.entries(posts);
                console.log('Found', postEntries.length, 'posts');
                
                let html = `<h2>Found ${postEntries.length} posts:</h2>`;
                
                postEntries.forEach(([id, post]) => {
                    html += `
                        <div class="post">
                            <div class="post-header">
                                <span class="post-type ${post.type}">${post.type?.toUpperCase() || 'UNKNOWN'}</span>
                                ${post.title || 'No title'}
                            </div>
                            <p><strong>Description:</strong> ${post.description || 'No description'}</p>
                            <p><strong>Location:</strong> ${post.location || 'No location'}</p>
                            <p><strong>Labels:</strong> ${post.labels ? post.labels.join(', ') : 'No labels'}</p>
                            <p><strong>User:</strong> ${post.user?.uid || 'No user'} (${post.user?.username || 'No username'})</p>
                            <p><strong>ID:</strong> ${id}</p>
                        </div>
                    `;
                });
                
                output.innerHTML = html;
            } catch (error) {
                output.innerHTML = `<p style="color: red;">Error loading posts: ${error.message}</p>`;
                console.error('Error loading posts:', error);
            }
        };

        window.createTestPosts = async function() {
            if (!currentUser) {
                alert('Please log in first to create test posts');
                return;
            }
            
            const output = document.getElementById('output');
            output.innerHTML = '<p>Creating test posts...</p>';
            
            try {
                // Create a lost item
                const lostPost = {
                    title: "Lost Black iPhone 13 Pro",
                    description: "Lost my black iPhone 13 Pro near the main entrance of Central Park. Has a blue case.",
                    type: "lost",
                    location: "Central Park, NYC",
                    labels: ["phone", "iphone", "apple", "black", "electronics"],
                    user: {
                        uid: currentUser.uid,
                        username: currentUser.displayName || "testuser"
                    },
                    timestamp: Date.now(),
                    imageData: null
                };
                
                // Create a found item (simulate different user)
                const foundPost = {
                    title: "Found iPhone 13 at Central Park",
                    description: "Found an iPhone 13 Pro near Central Park entrance. It's black with a blue protective case.",
                    type: "found", 
                    location: "Central Park, NYC",
                    labels: ["phone", "iphone", "apple", "black"],
                    user: {
                        uid: "test-user-456",
                        username: "finderguy"
                    },
                    timestamp: Date.now(),
                    imageData: null
                };
                
                await push(ref(db, 'posts'), lostPost);
                await push(ref(db, 'posts'), foundPost);
                
                output.innerHTML = `
                    <p style="color: green;">✅ Test posts created successfully!</p>
                    <p>Created a LOST post for current user and a FOUND post for a different user.</p>
                    <button onclick="loadPosts()">Refresh Posts</button>
                `;
                
            } catch (error) {
                output.innerHTML = `<p style="color: red;">❌ Error creating test posts: ${error.message}</p>`;
                console.error('Error creating test posts:', error);
            }
        };

        window.testRecommendations = async function() {
            const output = document.getElementById('output');
            output.innerHTML = '<p>Testing recommendation algorithm...</p>';
            
            try {
                const snapshot = await get(ref(db, 'posts'));
                const posts = snapshot.val();
                
                if (!posts) {
                    output.innerHTML = '<p>No posts to test with.</p>';
                    return;
                }
                
                const postEntries = Object.entries(posts).map(([id, post]) => ({id, ...post}));
                const userPosts = postEntries.filter(p => p.user?.uid === currentUser?.uid);
                const otherPosts = postEntries.filter(p => p.user?.uid !== currentUser?.uid);
                
                console.log('User posts:', userPosts.length);
                console.log('Other posts:', otherPosts.length);
                
                let html = `
                    <h2>Recommendation Test Results</h2>
                    <p>Your posts: ${userPosts.length}</p>
                    <p>Other posts: ${otherPosts.length}</p>
                    <h3>Potential Matches:</h3>
                `;
                
                let matchCount = 0;
                
                for (const userPost of userPosts) {
                    for (const otherPost of otherPosts) {
                        if (userPost.type === otherPost.type) continue; // Only opposite types
                        
                        // Simple text similarity test
                        const text1 = `${userPost.title} ${userPost.description}`.toLowerCase();
                        const text2 = `${otherPost.title} ${otherPost.description}`.toLowerCase();
                        
                        const words1 = text1.split(/\s+/);
                        const words2 = text2.split(/\s+/);
                        const commonWords = words1.filter(w => words2.includes(w) && w.length > 2);
                        
                        if (commonWords.length > 0) {
                            matchCount++;
                            html += `
                                <div class="post">
                                    <strong>Match ${matchCount}:</strong><br>
                                    <span class="post-type ${userPost.type}">${userPost.type}</span> "${userPost.title}" 
                                    <br>↔<br>
                                    <span class="post-type ${otherPost.type}">${otherPost.type}</span> "${otherPost.title}"
                                    <br><strong>Common words:</strong> ${commonWords.join(', ')}
                                </div>
                            `;
                        }
                    }
                }
                
                if (matchCount === 0) {
                    html += '<p>No potential matches found. Try creating test posts first.</p>';
                }
                
                output.innerHTML = html;
                
            } catch (error) {
                output.innerHTML = `<p style="color: red;">Error testing recommendations: ${error.message}</p>`;
                console.error('Error testing recommendations:', error);
            }
        };
    </script>
</body>
</html>
