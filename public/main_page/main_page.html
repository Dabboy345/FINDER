<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Finder - Main Page</title>
  <link rel="stylesheet" href="main_page.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body>
  <nav class="navbar">
    <div class="logo">Finder</div>
    <div class="nav-links">
      <a href="#" class="active" id="homeBtn"><i class="fas fa-home"></i> Home</a>
      <a href="../profile/profile.html" id="profileBtn"><i class="fas fa-user"></i> Profile</a>
      <div class="notification-container">
        <i class="fas fa-bell"></i>
        <span id="notificationBadge">0</span>
      </div>
      <a href="post-creation.html" class="btn create-btn"><i class="fas fa-plus-circle"></i> Create Post</a>
      <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
    </div>
  </nav>

  <div class="main-content">
    <div class="feed-header">
      <h1>Welcome to Finder</h1>
      <h2>Lost something? Found something?</h2>
      <p>Connect with your community to find lost items or help others find theirs.</p>
      <!-- MATCHING BUTTON -->
      <button id="findMatchesBtn" class="btn" style="margin-top:1rem;">
        <i class="fas fa-link"></i> Find Matches
      </button>
      <!-- AI RECOMMENDATIONS BUTTON -->
      <button id="aiRecommendationsBtn" class="btn ai-recommendations-btn" style="margin-top:1rem; margin-left:1rem;">
        <i class="fas fa-brain"></i> AI Recommendations
      </button>
    </div>

    <!-- AI Recommendations Section -->
    <div id="aiRecommendationsSection" class="ai-recommendations-section" style="display: none;">
      <div class="ai-header">
        <div class="ai-title">
          <i class="fas fa-brain ai-icon"></i>
          <h2>AI-Powered Recommendations</h2>
        </div>
        <p class="ai-subtitle">Intelligent suggestions based on advanced matching algorithms</p>
      </div>
      
      <div class="recommendations-container">
        <div class="recommendation-filters">
          <button class="filter-btn active" data-filter="all">All Recommendations</button>
          <button class="filter-btn" data-filter="high">High Match</button>
          <button class="filter-btn" data-filter="medium">Medium Match</button>
          <button class="filter-btn" data-filter="visual">Visual Similarity</button>
        </div>
        
        <div id="recommendationsGrid" class="recommendations-grid">
          <!-- AI recommendations will be populated here -->
        </div>
        
        <div class="ai-insights">
          <h3><i class="fas fa-lightbulb"></i> AI Insights</h3>
          <div id="aiInsightsContent">
            <p>The AI analyzes multiple factors to find the best matches:</p>
            <ul>
              <li><i class="fas fa-tag"></i> Tag similarity and semantic meaning</li>
              <li><i class="fas fa-font"></i> Text description analysis</li>
              <li><i class="fas fa-image"></i> Visual characteristics comparison</li>
              <li><i class="fas fa-map-marker-alt"></i> Location proximity</li>
              <li><i class="fas fa-clock"></i> Temporal relevance</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <div class="posts-container">
      <!-- Posts will be loaded here dynamically -->
    </div>
  </div>

  <!-- Claim Modal -->
  <div id="claimModal" class="modal" style="display: none;">
    <div class="modal-content">
      <span class="close" id="closeClaimModal">&times;</span>
      <h2>Send a Message to the Finder</h2>
      <div class="contact-section">
        <p>Send a message to <span id="finderEmail"></span> about this item:</p>
        <textarea id="claimMessage" placeholder="Write your message here..." rows="4"></textarea>
        <div class="modal-buttons">
          <button id="cancelClaimBtn">Cancel</button>
          <button id="sendClaimBtn">Send Message</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Chat Modal -->
  <div id="chatModal" class="modal" style="display: none;">
    <div class="modal-content chat-modal">
      <div class="chat-header">
        <div class="chat-info">
          <h2>Chat</h2>
          <p>Chatting with <span id="chatWithUser"></span></p>
          <p class="chat-item-title">Item: <span id="chatItemTitle"></span></p>
        </div>
        <span class="close" id="closeChatModal">&times;</span>
      </div>
      <div class="chat-messages" id="chatMessages">
        <!-- Messages will be loaded here -->
      </div>
      <div class="chat-input-container">
        <textarea id="chatMessageInput" placeholder="Type your message..." rows="2"></textarea>
        <button id="sendChatMessage">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Match Suggestion Modal -->
  <div id="matchSuggestionModal" class="modal" style="display: none;">
    <div class="modal-content match-modal">
      <span class="close" id="closeMatchModal">&times;</span>
      <div class="match-header">
        <i class="fas fa-link match-icon"></i>
        <h2>You have a possible match!</h2>
      </div>
      <div class="match-content">
        <p>We found a potential match based on your item characteristics:</p>
        <div class="match-comparison">
          <div class="match-item">
            <h3>Your Post</h3>
            <div id="yourPostDetails"></div>
          </div>
          <div class="match-arrow">
            <i class="fas fa-arrows-alt-h"></i>
          </div>
          <div class="match-item">
            <h3>Potential Match</h3>
            <div id="matchedPostDetails"></div>
          </div>
        </div>
        <div class="shared-labels">
          <p><strong>Matching characteristics:</strong> <span id="sharedLabels"></span></p>
        </div>
        <div class="match-actions">
          <button id="viewMatchDetailsBtn" class="btn btn-primary">
            <i class="fas fa-eye"></i> View Details
          </button>
          <button id="dismissMatchBtn" class="btn btn-secondary">
            <i class="fas fa-times"></i> Dismiss
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="notification-dropdown"></div>

  <script type="module" src="main_page.js"></script>
  <script>
    // Add notification dropdown
    const notificationContainer = document.querySelector('.notification-container');
    const notificationDropdown = document.createElement('div');
    notificationDropdown.className = 'notification-dropdown';
    notificationContainer.appendChild(notificationDropdown);

    let unreadNotifications = 0;

    // Function to update notification badge
    function updateNotificationBadge(count) {
      const badge = document.getElementById('notificationBadge');
      if (count > 0) {
        badge.style.display = 'block';
        badge.textContent = count;
      } else {
        badge.style.display = 'none';
      }
    }

    // Listen for notifications
    function listenForNotifications(userId) {
      const notificationsRef = ref(db, 'notifications');
      onValue(notificationsRef, (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        unreadNotifications = Object.values(data)
          .filter(n => n.to === userId && !n.read)
          .length;
        
        updateNotificationBadge(unreadNotifications);
      });
    }

    // Load notifications
    async function loadNotifications() {
      if (!currentUser) return;

      const notificationsRef = ref(db, 'notifications');
      const snapshot = await get(notificationsRef);
      const data = snapshot.val();
      
      if (!data) {
        notificationDropdown.innerHTML = '<div class="notification-item">No notifications</div>';
        return;
      }

      const notifications = Object.entries(data)
        .filter(([, n]) => n.to === currentUser.uid)
        .sort(([, a], [, b]) => (b.lastUpdated || b.timestamp || 0) - (a.lastUpdated || a.timestamp || 0));

      notificationDropdown.innerHTML = notifications.map(([id, notification]) => {
        const timeString = new Date(notification.lastUpdated || notification.timestamp).toLocaleString();
        return `
          <div class="notification-item ${notification.read ? '' : 'unread'}" data-id="${id}">
            <div class="notification-title">
              <i class="fas ${notification.type === 'claim' ? 'fa-hand-holding' : 'fa-tag'}"></i>
              ${notification.title}
            </div>
            <div class="notification-message">
              ${notification.message}
            </div>
            <div class="notification-time">${timeString}</div>
          </div>
        `;
      }).join('');

      // Add click handler for notification items
      notificationDropdown.querySelectorAll('.notification-item').forEach(item => {
        item.addEventListener('click', () => {
          const notificationId = item.dataset.id;
          // You can redirect or show details here, e.g.:
          // window.location.href = `post-details.html?id=${notification.postId}`;
        });
      });
    }

    // Toggle notification dropdown
    notificationContainer.addEventListener('click', () => {
      notificationDropdown.classList.toggle('show');
      if (notificationDropdown.classList.contains('show')) {
        loadNotifications();
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!notificationContainer.contains(e.target)) {
        notificationDropdown.classList.remove('show');
      }
    });

    // Listen for notifications when user is logged in
    onAuthStateChanged(auth, (user) => {
      if (user) {
        listenForNotifications(user.uid);
      }
    });
  </script>
</body>
</html>