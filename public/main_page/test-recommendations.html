<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test AI Recommendations Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-button {
            background: #1976D2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .test-button:hover {
            background: #1565C0;
        }
        .test-result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
        }
        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
        }
        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
        }
        .console-log {
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #333;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ðŸ”§ AI Recommendations Fix Test</h1>
        <p>This page tests if the <code>ReferenceError: recommendations is not defined</code> has been fixed.</p>
        
        <button class="test-button" onclick="testRecommendationsVariable()">Test Recommendations Variable</button>
        <button class="test-button" onclick="testBasicFunction()">Test Basic Function Structure</button>
        <button class="test-button" onclick="simulateRecommendations()">Simulate AI Recommendations</button>
        
        <div id="testResults"></div>
        
        <h3>Console Output:</h3>
        <div id="consoleOutput" class="test-result console-log"></div>
    </div>

    <!-- Load Firebase and dependencies -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.7.3/firebase-auth.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAwdWGNxqwWEMgFSUnzCWJ0p-sykDJfQnw",
            authDomain: "lostfound-79fd1.firebaseapp.com",
            databaseURL: "https://lostfound-79fd1-default-rtdb.firebaseio.com",
            projectId: "lostfound-79fd1",
            storageBucket: "lostfound-79fd1.firebasestorage.app",
            messagingSenderId: "925491306433",
            appId: "1:925491306433:web:56e2ad2bc1a8e4ba29e8fb"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        window.db = getDatabase(app);
        window.auth = getAuth(app);

        // Mock user for testing
        window.currentUser = { uid: 'test-user-123' };

        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const consoleOutput = document.getElementById('consoleOutput');

        function appendToConsole(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = `[${timestamp}] ${type.toUpperCase()}: ${args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ')}\n`;
            consoleOutput.textContent += message;
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            appendToConsole('log', ...args);
        };

        console.error = (...args) => {
            originalError(...args);
            appendToConsole('error', ...args);
        };

        window.ref = ref;
        window.get = get;
    </script>

    <!-- Load the AI functions -->
    <script src="openai-service.js"></script>
    <script src="main_page.js"></script>

    <script>
        function showResult(message, isSuccess = true) {
            const resultsDiv = document.getElementById('testResults');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${isSuccess ? 'success' : 'error'}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }

        function testRecommendationsVariable() {
            console.log('ðŸ§ª Testing recommendations variable scope...');
            
            try {
                // Test if we can access the function
                if (typeof showAIRecommendations === 'function') {
                    showResult('âœ… showAIRecommendations function exists');
                    console.log('âœ… showAIRecommendations function found');
                } else {
                    showResult('âŒ showAIRecommendations function not found', false);
                    console.error('âŒ showAIRecommendations function not found');
                    return;
                }

                // Check if the function can be called without immediate errors
                console.log('Testing function structure...');
                showResult('âœ… Function structure test passed');
                
            } catch (error) {
                showResult(`âŒ Test failed: ${error.message}`, false);
                console.error('âŒ Test failed:', error);
            }
        }

        function testBasicFunction() {
            console.log('ðŸ§ª Testing basic function components...');
            
            try {
                // Test if helper functions exist
                const functions = [
                    'calculateSmartSimilarity',
                    'getMatchingFactors', 
                    'userAIUsageCount',
                    'escapeHtml'
                ];

                let allFound = true;
                functions.forEach(funcName => {
                    if (typeof window[funcName] === 'function') {
                        console.log(`âœ… ${funcName} function found`);
                    } else {
                        console.error(`âŒ ${funcName} function not found`);
                        allFound = false;
                    }
                });

                if (allFound) {
                    showResult('âœ… All helper functions found');
                } else {
                    showResult('âš ï¸ Some helper functions missing', false);
                }

            } catch (error) {
                showResult(`âŒ Function test failed: ${error.message}`, false);
                console.error('âŒ Function test failed:', error);
            }
        }

        async function simulateRecommendations() {
            console.log('ðŸ§ª Testing simulated AI recommendations...');
            
            try {
                // Mock some test data
                const mockPostsData = {
                    'post1': {
                        id: 'post1',
                        title: 'Boli rojo perdido',
                        description: 'Un bolÃ­grafo rojo perdido en el campus',
                        type: 'lost',
                        user: { uid: 'test-user-123' },
                        labels: ['boli', 'rojo']
                    },
                    'post2': {
                        id: 'post2', 
                        title: 'Boli Vermell trobat',
                        description: 'Pen vermell trobat a la biblioteca',
                        type: 'found',
                        user: { uid: 'other-user-456' },
                        labels: ['boli', 'vermell']
                    }
                };

                console.log('Mock data created:', mockPostsData);

                // Test smart similarity calculation
                if (typeof calculateSmartSimilarity === 'function') {
                    const score = calculateSmartSimilarity(mockPostsData.post1, mockPostsData.post2);
                    console.log(`Smart similarity score: ${score}`);
                    
                    if (score > 0) {
                        showResult(`âœ… Smart similarity working: ${(score * 100).toFixed(1)}% match`);
                    } else {
                        showResult('âš ï¸ Smart similarity returned 0 score', false);
                    }
                } else {
                    console.error('calculateSmartSimilarity function not found');
                    showResult('âŒ calculateSmartSimilarity function missing', false);
                }

                // Test that recommendations array can be created
                try {
                    let testRecommendations = [];
                    testRecommendations.push({
                        userPost: mockPostsData.post1,
                        matchedPost: mockPostsData.post2,
                        totalScore: 85,
                        confidence: 85
                    });
                    
                    console.log('Test recommendations array:', testRecommendations);
                    showResult(`âœ… Recommendations array working: ${testRecommendations.length} items`);
                    
                } catch (error) {
                    console.error('Error creating recommendations array:', error);
                    showResult(`âŒ Recommendations array error: ${error.message}`, false);
                }

            } catch (error) {
                showResult(`âŒ Simulation failed: ${error.message}`, false);
                console.error('âŒ Simulation failed:', error);
            }
        }

        // Run initial test on page load
        setTimeout(() => {
            console.log('ðŸš€ Starting automatic tests...');
            testRecommendationsVariable();
        }, 1000);
    </script>
</body>
</html>
