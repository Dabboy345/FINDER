<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç OpenAI API Usage Diagnostic</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
        }
        .issue-card {
            background: #fff5f5;
            border-left: 5px solid #dc3545;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .issue-card h3 {
            color: #dc3545;
            margin: 0 0 10px 0;
        }
        .solution-card {
            background: #f0f9ff;
            border-left: 5px solid #0ea5e9;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .solution-card h3 {
            color: #0ea5e9;
            margin: 0 0 10px 0;
        }
        .test-button {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa500 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 10px 10px 0;
            transition: transform 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .test-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .console-output {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .console-line {
            margin: 5px 0;
            padding: 2px 0;
        }
        .console-error {
            color: #fc8181;
        }
        .console-success {
            color: #68d391;
        }
        .console-warning {
            color: #f6e05e;
        }
        .console-info {
            color: #63b3ed;
        }
        .api-key-display {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            word-break: break-all;
        }
        .highlight {
            background: #ffeaa7;
            padding: 2px 4px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç OpenAI API Usage Diagnostic</h1>
            <p>Investigating why no requests/credits show in OpenAI dashboard</p>
        </div>

        <div class="issue-card">
            <h3>üö® Problem Identified</h3>
            <p>Your OpenAI dashboard shows <strong>no API usage</strong> despite the application making calls. This suggests:</p>
            <ul>
                <li>API calls are failing before reaching OpenAI servers</li>
                <li>Invalid API key format or authentication issues</li>
                <li>Network/CORS blocking requests</li>
                <li>API calls being bypassed by fallback logic</li>
            </ul>
        </div>

        <button class="test-button" onclick="validateAPIKey()">üîë Validate API Key</button>
        <button class="test-button" onclick="testDirectAPICall()">üåê Test Direct API Call</button>
        <button class="test-button" onclick="testNetworkConnectivity()">üì° Test Network</button>
        <button class="test-button" onclick="checkAPIUsageFlow()">üîÑ Check Usage Flow</button>
        <button class="test-button" onclick="clearConsole()">üóëÔ∏è Clear Console</button>

        <div id="consoleOutput" class="console-output">
            <div class="console-line console-info">üîç OpenAI API Diagnostic Tool Ready</div>
            <div class="console-line console-warning">‚ö†Ô∏è Investigating why no usage appears in OpenAI dashboard</div>
        </div>

        <div id="testResults"></div>
    </div>

    <!-- Load config -->
    <script type="module">
        import { config } from '../config.js';
        window.openaiConfig = config.openai;
        window.firebaseConfig = config.firebase;
        
        // Enhanced console capture
        const consoleDiv = document.getElementById('consoleOutput');
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        function addConsoleLine(type, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const line = document.createElement('div');
            line.className = `console-line console-${type}`;
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            line.textContent = `[${timestamp}] ${message}`;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }

        console.log = (...args) => {
            originalLog(...args);
            addConsoleLine('info', ...args);
        };

        console.error = (...args) => {
            originalError(...args);
            addConsoleLine('error', ...args);
        };

        console.warn = (...args) => {
            originalWarn(...args);
            addConsoleLine('warning', ...args);
        };

        window.logSuccess = (...args) => {
            originalLog(...args);
            addConsoleLine('success', ...args);
        };
    </script>

    <script>
        function clearConsole() {
            const consoleDiv = document.getElementById('consoleOutput');
            consoleDiv.innerHTML = '<div class="console-line console-info">üßπ Console cleared</div>';
        }

        function showResult(title, success, details = '') {
            const resultsDiv = document.getElementById('testResults');
            const card = document.createElement('div');
            card.className = success ? 'solution-card' : 'issue-card';
            card.innerHTML = `
                <h3>${success ? '‚úÖ' : '‚ùå'} ${title}</h3>
                <p>${details}</p>
            `;
            resultsDiv.appendChild(card);
        }

        function validateAPIKey() {
            console.log('üîë VALIDATING OPENAI API KEY');
            console.log('='.repeat(40));

            const apiKey = window.openaiConfig?.apiKey;
            
            if (!apiKey) {
                console.error('‚ùå No API key found in config');
                showResult('API Key Validation', false, 'No API key found in configuration');
                return;
            }

            console.log('API Key found, analyzing...');
            
            // Display partially masked key
            const maskedKey = apiKey.substring(0, 20) + '...' + apiKey.substring(apiKey.length - 4);
            console.log('API Key (masked):', maskedKey);

            // Validate key format
            const issues = [];
            
            if (!apiKey.startsWith('sk-')) {
                issues.push('API key should start with "sk-"');
                console.error('‚ùå Invalid key format: should start with "sk-"');
            } else {
                logSuccess('‚úÖ API key starts with correct prefix');
            }

            if (apiKey.length < 50) {
                issues.push('API key seems too short');
                console.error('‚ùå API key appears too short (< 50 characters)');
            } else {
                logSuccess('‚úÖ API key length appears correct');
            }

            // Check for common issues
            if (apiKey.includes(' ')) {
                issues.push('API key contains spaces');
                console.error('‚ùå API key contains spaces');
            }

            if (apiKey.includes('\n') || apiKey.includes('\r')) {
                issues.push('API key contains line breaks');
                console.error('‚ùå API key contains line breaks');
            }

            // Check if it's the example/placeholder key
            if (apiKey.includes('your-api-key') || apiKey === 'sk-...') {
                issues.push('API key appears to be a placeholder');
                console.error('‚ùå API key appears to be a placeholder/example');
            }

            if (issues.length === 0) {
                logSuccess('‚úÖ API key format validation passed');
                showResult('API Key Validation', true, 'API key format appears correct. Key starts with "sk-" and has proper length.');
            } else {
                console.error('‚ùå API key validation failed:', issues.join(', '));
                showResult('API Key Validation', false, `Issues found: ${issues.join(', ')}`);
            }
        }

        async function testDirectAPICall() {
            console.log('üåê TESTING DIRECT OPENAI API CALL');
            console.log('='.repeat(40));

            const apiKey = window.openaiConfig?.apiKey;
            
            if (!apiKey) {
                console.error('‚ùå No API key available for testing');
                showResult('Direct API Test', false, 'No API key available');
                return;
            }

            try {
                console.log('Making direct fetch call to OpenAI API...');
                console.log('Endpoint: https://api.openai.com/v1/chat/completions');
                
                const startTime = Date.now();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-3.5-turbo",
                        messages: [{
                            role: "user",
                            content: "Respond with just the number: 42"
                        }],
                        max_tokens: 10
                    })
                });

                const endTime = Date.now();
                const responseTime = endTime - startTime;

                console.log(`Response status: ${response.status}`);
                console.log(`Response time: ${responseTime}ms`);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå API call failed');
                    console.error('Error status:', response.status);
                    console.error('Error response:', errorText);
                    
                    let errorDetails = '';
                    if (response.status === 401) {
                        errorDetails = 'Invalid API key - check if key is correct and active';
                    } else if (response.status === 429) {
                        errorDetails = 'Rate limit exceeded - but this means API key is valid!';
                    } else if (response.status === 404) {
                        errorDetails = 'Endpoint not found - check URL';
                    } else {
                        errorDetails = `HTTP ${response.status}: ${errorText}`;
                    }
                    
                    showResult('Direct API Test', false, errorDetails);
                    return;
                }

                const data = await response.json();
                console.log('‚úÖ API call successful!');
                console.log('Response data:', data);
                
                if (data.choices && data.choices[0]) {
                    logSuccess(`‚úÖ Received response: "${data.choices[0].message.content}"`);
                    logSuccess(`‚úÖ Model used: ${data.model || 'unknown'}`);
                    logSuccess(`‚úÖ Request ID: ${data.id || 'unknown'}`);
                }

                if (data.usage) {
                    logSuccess(`‚úÖ Token usage - Prompt: ${data.usage.prompt_tokens}, Completion: ${data.usage.completion_tokens}, Total: ${data.usage.total_tokens}`);
                    showResult('Direct API Test', true, `API call successful! Used ${data.usage.total_tokens} tokens. This should appear in your OpenAI dashboard.`);
                } else {
                    console.warn('‚ö†Ô∏è No usage data in response');
                    showResult('Direct API Test', true, 'API call successful but no usage data returned. Check OpenAI dashboard for billing.');
                }

            } catch (error) {
                console.error('‚ùå Network error making API call:', error);
                showResult('Direct API Test', false, `Network error: ${error.message}. This could be CORS, network issues, or blocked requests.`);
            }
        }

        async function testNetworkConnectivity() {
            console.log('üì° TESTING NETWORK CONNECTIVITY');
            console.log('='.repeat(40));

            const tests = [
                {
                    name: 'OpenAI API Endpoint',
                    url: 'https://api.openai.com/v1/models',
                    method: 'GET'
                },
                {
                    name: 'General Internet',
                    url: 'https://httpbin.org/json',
                    method: 'GET'
                },
                {
                    name: 'CORS Preflight',
                    url: 'https://api.openai.com/v1/chat/completions',
                    method: 'OPTIONS'
                }
            ];

            let allPassed = true;

            for (const test of tests) {
                try {
                    console.log(`Testing ${test.name}...`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    
                    const startTime = Date.now();
                    
                    const response = await fetch(test.url, {
                        method: test.method,
                        signal: controller.signal,
                        headers: test.name === 'OpenAI API Endpoint' ? {
                            'Authorization': `Bearer ${window.openaiConfig?.apiKey || 'test'}`
                        } : {}
                    });
                    
                    clearTimeout(timeoutId);
                    const endTime = Date.now();
                    
                    console.log(`${test.name}: ${response.status} (${endTime - startTime}ms)`);
                    
                    if (response.ok || response.status === 401) { // 401 is OK for API key tests
                        logSuccess(`‚úÖ ${test.name}: Reachable`);
                    } else {
                        console.warn(`‚ö†Ô∏è ${test.name}: ${response.status}`);
                    }
                    
                } catch (error) {
                    console.error(`‚ùå ${test.name}: ${error.message}`);
                    allPassed = false;
                }
            }

            if (allPassed) {
                showResult('Network Connectivity', true, 'All network tests passed. OpenAI API is reachable.');
            } else {
                showResult('Network Connectivity', false, 'Some network tests failed. Check internet connection and firewall settings.');
            }
        }

        async function checkAPIUsageFlow() {
            console.log('üîÑ CHECKING API USAGE FLOW');
            console.log('='.repeat(40));

            // Check current application logic
            console.log('Analyzing application API usage patterns...');
            
            // Check if the app is actually making OpenAI calls
            let actualAPICallsMade = false;
            
            // Check localStorage for AI usage tracking
            const aiUsage = localStorage.getItem('aiUsageCount');
            const aiUsageTime = localStorage.getItem('aiUsageLastHour');
            
            console.log('Local AI usage tracking:');
            console.log('- Usage count:', aiUsage || 'not set');
            console.log('- Last usage time:', aiUsageTime || 'not set');
            
            if (aiUsage && parseInt(aiUsage) > 0) {
                logSuccess('‚úÖ Local usage tracking shows API calls were attempted');
                actualAPICallsMade = true;
            } else {
                console.warn('‚ö†Ô∏è No local usage tracking found');
            }

            // Check if rate limiting is preventing calls
            const rateLimitStatus = localStorage.getItem('openai_rate_limit_status');
            if (rateLimitStatus) {
                console.log('Rate limit status:', rateLimitStatus);
                console.warn('‚ö†Ô∏è Rate limiting may be preventing API calls');
            }

            // Common reasons why calls don't reach OpenAI:
            const issues = [];
            
            console.log('Analyzing potential issues:');
            
            // 1. Check if smart matching is being used instead
            console.log('1. Checking if smart matching bypass is active...');
            if (typeof calculateSmartSimilarity === 'function') {
                console.log('‚úÖ Smart matching function available - may be used instead of API');
                issues.push('Smart matching may be bypassing OpenAI calls');
            }
            
            // 2. Check if OpenAI service is being loaded
            console.log('2. Checking if OpenAI service module is loaded...');
            // The fact that we can access the config suggests it's loaded
            
            // 3. Check for common config issues
            console.log('3. Checking configuration issues...');
            if (!window.openaiConfig) {
                issues.push('OpenAI configuration not loaded');
                console.error('‚ùå OpenAI config not accessible');
            }
            
            // 4. Check if API calls are being made in testing
            console.log('4. Testing if API calls are actually triggered...');
            
            const recommendations = [
                'Enable verbose logging in main_page.js to track API call attempts',
                'Check browser DevTools Network tab during AI recommendations',
                'Verify that showAIRecommendations() actually calls OpenAI functions',
                'Test with a minimal API call to confirm OpenAI billing tracking'
            ];
            
            console.log('Recommendations to identify the issue:');
            recommendations.forEach((rec, i) => {
                console.log(`${i + 1}. ${rec}`);
            });

            if (issues.length > 0) {
                showResult('API Usage Flow', false, `Potential issues: ${issues.join(', ')}. The app may be using fallback logic instead of making actual OpenAI API calls.`);
            } else {
                showResult('API Usage Flow', true, 'No obvious flow issues detected. The problem may be in the specific API call logic or timing.');
            }
        }

        // Auto-run initial diagnostics
        setTimeout(() => {
            console.log('üöÄ Running initial diagnostics...');
            validateAPIKey();
        }, 1000);
    </script>
</body>
</html>
